<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Trang chủ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/chat_box.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script> <!-- Thêm SockJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script> <!-- Thêm StompJS -->

  <style>
    body {
      display: flex;
      flex-direction: column;
      background-image: url('https://img5.thuthuatphanmem.vn/uploads/2022/01/10/anh-bia-zalo-phong-canh-vinh-ha-long-tuyet-dep_024649572.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
  </style>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="#">Hotel Management</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li>
          <a class="nav-link active" href="/user/userHome">Trang chủ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/user/list-rooms">Danh sách phòng</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/bookings">Đặt phòng</a>
        </li>
      </ul>
      <div class="d-flex">
                    <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
                        Xin chào, <span sec:authentication="name"></span>
                    </span>
        <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">
          <button type="submit" class="btn btn-outline-light">Đăng xuất</button>
        </form>
        <a href="/login" class="btn btn-outline-light" sec:authorize="!isAuthenticated()">Đăng nhập</a>
      </div>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="jumbotron" style="color: white">
    <h1 class="display-4">Chào mừng đến với Hotel Management</h1>
    <p class="lead">Hệ thống quản lý khách sạn hiện đại và tiện lợi</p>
    <hr class="my-4">
    <p>Bạn có thể dễ dàng đặt phòng, xem thông tin và quản lý các dịch vụ của chúng tôi.</p>
  </div>
</div>


<button id="toggleChatButton" class="btn btn-primary">Hộp Chat<div class="notification"></div></button>

<div id="chatBox" class="chat-box" style="display: none;">
  <h4>Hộp Chat</h4>
  <div class="chat-messages">
    <ul id="chat-messages">
    </ul>
  </div>
  <div class="chat-input">
    <input type="text" id="content" placeholder="Nhập tin nhắn...">
    <button onclick="sendMessage()">Gửi</button>
  </div>
</div>

<script th:inline="javascript">
  let socket = new SockJS('/ws-chat');
  let stompClient = Stomp.over(socket);
  let userId = /*[[${#authentication.principal.userId}]]*/ null; // Lấy userId từ principal
  let chatRoomId = null; // Initialize chatRoomId

  if (userId === null) {
    console.error("User ID is not available.");
  }

  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);

    document.getElementById("toggleChatButton").addEventListener("click", function() {
      toggleChatBox();
    });
  }, function (error) {
    console.error("Error connecting to WebSocket:", error);
  });

  function toggleChatBox() {
    var chatBox = document.getElementById("chatBox");
    chatBox.style.display = chatBox.style.display === "none" ? "block" : "none";

    if (chatBox.style.display === "block") {
      getOrCreateChatRoom();
    }
  }

  function getOrCreateChatRoom() {
    // Send request to server to get or create chat room
    fetch('/api/chatRoom/getOrCreate?userId=' + userId)
            .then(response => response.json())
            .then(data => {
              chatRoomId = data.chatRoomId;
              console.log("Chat Room ID:", chatRoomId);

              // Kết nối WebSocket và subscribe vào topic
              connectWebSocket(chatRoomId);
            })
            .catch(error => {
              console.error("Error getting or creating chat room:", error);
              // Hiển thị thông báo lỗi cho user
              alert("Failed to get or create chat room. Please try again later.");
            });
  }

  function connectWebSocket(chatRoomId) {
    stompClient.subscribe('/topic/chat.' + chatRoomId, function (message) {
      showMessage(JSON.parse(message.body));
    });
  }

  function sendMessage() {
    let content = document.getElementById("content").value;
    stompClient.send("/app/chat.send?chatRoomId=" + chatRoomId + "&content=" + content, {senderType: 'user'}, JSON.stringify({}));
  }

  function showMessage(message) {
    let chatBox = document.getElementById("chat-messages");
    let li = document.createElement("li");
    let div = document.createElement("div");

    div.classList.add("message");
    div.innerHTML = "<p>" + message.content + "</p><span class='message-time'>" + getCurrentTime() + "</span>";

    if (message.sender === userId.toString()) {
      li.classList.add("message-container", "received");
    } else {
      li.classList.add("message-container", "sent");
    }

    li.appendChild(div);
    chatBox.appendChild(li);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function getCurrentTime() {
    let now = new Date();
    let hours = now.getHours();
    let minutes = now.getMinutes();
    let ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    minutes = minutes < 10 ? '0'+minutes : minutes;
    let strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>