<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Dọn Dẹp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

    <div class="container mt-4">
        <h2>Danh sách phòng cần dọn dẹp</h2>
        <ul id="cleaningList" class="list-group"></ul>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <h4>Xin chào, nhân viên dọn dẹp!</h4>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-danger">Đăng xuất</button>
        </form>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>STT</th>
            <th>Hình Ảnh</th>
            <th>Loại Phòng</th>
            <th>Trạng Thái</th>
            <th>Mô Tả</th>
            <th>Hành Động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="room, iterStat : ${rooms}">
            <td th:text="${iterStat.count}"></td>
            <td><img th:src="${room.roomImg}" class="img-thumbnail" width="100px"></td>
            <td th:text="${room.roomType.roomTypeName}"></td>
            <td><span class="badge bg-secondary">Đang Dọn</span></td>
            <td th:text="${room.roomDescription}"></td>
            <td>
                <form th:id="'cleaningForm-' + ${room.roomId}" th:action="@{/cleaner-home/update}" method="post">
                    <input type="hidden" name="roomId" th:value="${room.roomId}">
                    <button type="button" class="btn btn-success" th:attr="onclick=|confirmCleaning(${room.roomId})|">
                        Hoàn Thành
                    </button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    function confirmCleaning(roomId) {
        Swal.fire({
            title: "Xác nhận hoàn thành?",
            text: "Bạn có chắc chắn đã dọn dẹp xong phòng này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#d33",
            confirmButtonText: "Có, đã hoàn thành!"
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("cleaningForm-" + roomId).submit();
            }
        });
    }
    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        stompClient.subscribe('/topic/cleaning', function (notification) {
            showNotification(notification.body);
            addCleaningTask(notification.body);
        });
    });

    function showNotification(message) {
        let toastContainer = document.getElementById("toastContainer");
        let toastHTML = `
            <div class="toast show bg-warning text-dark" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Thông báo dọn dẹp</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>`;

        toastContainer.innerHTML += toastHTML;
        setTimeout(() => {
            let toast = document.querySelector(".toast");
            toast.classList.remove("show");
            toast.remove();
        }, 5000);
    }

    function addCleaningTask(message) {
        let cleaningList = document.getElementById("cleaningList");
        let roomId = message.match(/\d+/)[0];
        let taskHTML = `<li class="list-group-item">Phòng ${roomId} cần dọn dẹp</li>`;
        cleaningList.innerHTML += taskHTML;
    }
</script>

</body>
</html>
