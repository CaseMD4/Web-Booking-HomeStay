<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Dọn Dẹp</title>
    <link rel="stylesheet" href="../../static/css/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>

</head>
<body>

<div class="notification-badge" onclick="toggleNotificationList()">0</div>

<div class="notification-list">
    <ul></ul>
</div>

<div class="container mt-4">

    <div class="notification-details">
        <h4>Chi tiết phòng</h4>
        <p><strong>Phòng:</strong> <span id="detailRoomId"></span></p>
        <p><strong>Loại:</strong> <span id="detailRoomType"></span></p>
        <p><strong>Mô tả:</strong> <span id="detailRoomDescription"></span></p>
        <p><strong>Trạng thái:</strong> Cần dọn dẹp</p>
        <button onclick="closeNotificationDetails()">Đóng</button>
    </div>

    <h2>Danh sách phòng cần dọn dẹp</h2>
    <ul id="cleaningList" class="list-group"></ul>

    <div class="d-flex justify-content-between mb-3">
        <h4>Xin chào, nhân viên dọn dẹp!</h4>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-danger">Đăng xuất</button>
        </form>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>STT</th>
            <th>Hình Ảnh</th>
            <th>Loại Phòng</th>
            <th>Trạng Thái</th>
            <th>Mô Tả</th>
            <th>Hành Động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="room, iterStat : ${rooms}">
            <td th:text="${iterStat.count}"></td>
            <td><img th:src="${room.roomImg}" class="img-thumbnail" width="100px"></td>
            <td th:text="${room.roomType.roomTypeName}"></td>
            <td><span class="badge bg-secondary">Đang Dọn</span></td>
            <td th:text="${room.roomDescription}"></td>
            <td>
                <form th:id="'cleaningForm-' + ${room.roomId}" th:action="@{/cleaner-home/update}" method="post">
                    <input type="hidden" name="roomId" th:value="${room.roomId}">
                    <button type="button" class="btn btn-success" th:attr="onclick=|confirmCleaning(${room.roomId})|">
                        Hoàn Thành
                    </button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let socket = new SockJS('/ws-chat');
    let stompClient = Stomp.over(socket);

    let notifications = []; // Store notifications
    let notificationCount = 0; // Number of notifications

    stompClient.connect({}, function () {
        stompClient.subscribe('/topic/cleaning', function (notification) {
            let cleaningInfo = JSON.parse(notification.body);
            addNotification(cleaningInfo);
        });
    });

    function addNotification(cleaningInfo) {
        notifications.push(cleaningInfo);
        notificationCount++;
        updateNotificationBadge();
    }

    function updateNotificationBadge() {
        let badge = document.querySelector('.notification-badge');
        badge.textContent = notificationCount;
        badge.classList.add('glowing'); // Add glowing effect
    }

    function toggleNotificationList() {
        let list = document.querySelector('.notification-list');
        list.classList.toggle('show');
        // Remove glowing effect when the list is opened
        document.querySelector('.notification-badge').classList.remove('glowing');
        notificationCount = 0;
        updateNotificationBadge();
        populateNotificationList();
    }

    function populateNotificationList() {
        let list = document.querySelector('.notification-list ul');
        list.innerHTML = ""; // Clear the list
        notifications.forEach(function (notification, index) {
            let listItem = document.createElement('li');
            listItem.textContent = `Phòng ${notification.roomId} (${notification.roomType})`;
            listItem.onclick = function () {
                showNotificationDetails(index);
            };
            list.appendChild(listItem);
        });
    }

    function showNotificationDetails(index) {
        let notification = notifications[index];
        document.getElementById('detailRoomId').textContent = notification.roomId;
        document.getElementById('detailRoomType').textContent = notification.roomType;
        document.getElementById('detailRoomDescription').textContent = notification.roomDescription;
        document.querySelector('.notification-details').classList.add('show');
    }

    function closeNotificationDetails() {
        document.querySelector('.notification-details').classList.remove('show');
    }

    function confirmCleaning(roomId) {
        Swal.fire({
            title: "Xác nhận hoàn thành?",
            text: "Bạn có chắc chắn đã dọn dẹp xong phòng này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#d33",
            confirmButtonText: "Có, đã hoàn thành!"
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("cleaningForm-" + roomId).submit();
            }
        });
    }
</script>

</body>
</html>