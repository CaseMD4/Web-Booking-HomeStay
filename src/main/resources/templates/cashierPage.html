<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Danh Sách Phòng</title>
    <link rel="stylesheet" th:href="@{/static/css/chat_box.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2 class="text-center">Cashier Management</h2>
    <div class="d-flex justify-content-between mb-3">
        <h4>Xin chào, <span sec:authentication="name"></span>!</h4>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-danger">Đăng xuất</button>
        </form>
    </div>


    <div class="mb-3">
        <form th:action="@{/cashier}" method="get" class="d-flex">
            <select name="status" class="form-select me-2">
                <option value="">Tất cả</option>
                <option value="available">Trống</option>
                <option value="booked">Đã Đặt</option>
                <option value="cleaning">Đang Dọn</option>
            </select>
            <button type="submit" class="btn btn-primary">Lọc</button>
        </form>
    </div>


    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>STT</th>
            <th>Hình Ảnh</th>
            <th>Loại Phòng</th>
            <th>Trạng Thái</th>
            <th>Giá</th>
            <th>Mô Tả</th>
            <th>Hành Động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="room, iterStat : ${rooms}">
            <td th:text="${iterStat.count}"></td>
            <td><img th:src="${room.roomImg}" class="img-thumbnail" width="100px"></td>
            <td th:text="${room.roomType.roomTypeName}"></td>
            <td>
                <span class="badge bg-success" th:if="${room.roomStatus == room.roomStatus.available}">Trống</span>
                <span class="badge bg-warning" th:if="${room.roomStatus == room.roomStatus.booked}">Đã Đặt</span>
                <span class="badge bg-secondary" th:if="${room.roomStatus == room.roomStatus.cleaning}">Đang Dọn</span>
            </td>
            <td th:text="${room.roomPrice} + ' VNĐ'"></td>
            <td th:text="${room.roomDescription}"></td>
            <td>
                <form th:action="@{'/cashier/' + ${room.roomId} + '/payment'}" method="get" th:if="${room.roomStatus == room.roomStatus.booked}">
                    <button type="submit" class="btn btn-danger mt-2">Thanh Toán</button>
                </form>
                <a th:href="@{'/cashier/' + ${room.roomId} + '/transactions'}" class="btn btn-info mt-2">Xem Lịch Sử</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>


<button id="toggleChatButton" class="btn btn-primary">Hộp Chat<div class="notification"></div></button>


<div id="chatBox" class="chat-box" style="display: none;">
    <h4>Hộp Chat</h4>
    <div class="chat-messages">
        <ul id="chat-messages">
        </ul>
    </div>
    <div class="chat-input">
        <input type="text" id="content" placeholder="Nhập tin nhắn...">
        <button onclick="sendMessage()">Gửi</button>
    </div>
</div>


<script th:inline="javascript">
    let socket = new SockJS('/ws-chat');
    let stompClient = Stomp.over(socket);


    let userId;
    let chatRoomId;
    let userName;


    let chatRooms = /*[[${chatRooms}]]*/ [];
    let cashierUsername = /*[[${#authentication.name}]]*/ ' ';


    let subscribedUsers = new Set(); // Danh sách userId đã subscribe


    stompClient.connect({}, function (frame) {
        console.log("Connected to WebSocket");


        document.getElementById("toggleChatButton").addEventListener("click", function () {
            toggleChatBox();
        });


        stompClient.subscribe('/topic/cashier.' + cashierUsername, function (notification) {
            let payload = JSON.parse(notification.body);
            chatRoomId = payload.chatRoomId;
            userId = payload.userId;
            userName = payload.userName;
            addNotification(chatRoomId, userId, userName);
        });
    });


    function addNotification(chatRoomId, userId, userName) {
        console.log("Received notification for chatRoomId:", chatRoomId, "userId:", userId);


        if (subscribedUsers.has(userId)) {
            console.log("Already subscribed to /topic/chat." + userId);
            return;
        }
        console.log("Subscribing to /topic/chat." + userId);
        subscribedUsers.add(userId); // Đánh dấu userId đã subscribe
        stompClient.subscribe('/topic/chat.' + userId, function (message) {
            let toggleChatButton = document.getElementById("toggleChatButton");
            toggleChatButton.classList.add("notification");
            showMessage(JSON.parse(message.body), userName);
        });
    }


    function sendMessage() {
        let content = document.getElementById("content").value;
        if (!content.trim()) return;


        let message = {
            content: content,
            senderType: 'cashier',
            chatRoomId: chatRoomId,
            userId: userId,
            sender: userName
        };


        console.log("Sending message:", message);




        //showMessage(message, "You");


        stompClient.send("/app/chat.send", {}, JSON.stringify(message));
        document.getElementById("content").value = "";
    }


    /* function showMessage(message, userName) {
         let chatBox = document.getElementById("chat-messages");
         let li = document.createElement("li");
         let div = document.createElement("div");


         div.classList.add("message");


         if (message.senderType === 'cashier' || userName === "You") {
             div.innerHTML = "<p><strong>You said:</strong> " + message.content +
                 "</p><span class='message-time'>" + getCurrentTime() + "</span>";
             li.classList.add("message-container", "sent");
             div.classList.add("sent");
         } else {
             div.innerHTML = "<p><strong>" + userName + ":</strong> " + message.content +
                 "</p><span class='message-time'>" + getCurrentTime() + "</span>";
             li.classList.add("message-container", "received");
             div.classList.add("received");
         }


         li.appendChild(div);
         chatBox.appendChild(li);
         chatBox.scrollTop = chatBox.scrollHeight;
     }
  */
    function showMessage(message, userName) {
        let chatBox = document.getElementById("chat-messages");
        let li = document.createElement("li");
        let div = document.createElement("div");


        div.classList.add("message");


        if (message.senderType === 'cashier' || userName === "You") {
            // Thêm kiểm tra để không hiển thị tin nhắn gửi từ cashier
            if (message.senderType === 'cashier' && userName === "You") {
                return; // Không hiển thị tin nhắn
            }
            div.innerHTML = "<p><strong>You said:</strong> " + message.content +
                "</p><span class='message-time'>" + getCurrentTime() + "</span>";
            li.classList.add("message-container", "sent");
            div.classList.add("sent");
        } else {
            div.innerHTML = "<p><strong>" + userName + ":</strong> " + message.content +
                "</p><span class='message-time'>" + getCurrentTime() + "</span>";
            li.classList.add("message-container", "received");
            div.classList.add("received");
        }


        li.appendChild(div);
        chatBox.appendChild(li);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function toggleChatBox() {
        var chatBox = document.getElementById("chatBox");
        chatBox.style.display = chatBox.style.display === "none" ? "block" : "none";
        let toggleChatButton = document.getElementById("toggleChatButton");
        toggleChatButton.classList.remove("notification");
    }


    function getCurrentTime() {
        let now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        let ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        let strTime = hours + ':' + minutes + ' ' + ampm;
        return strTime;
    }
</script>


</body>
</html>

